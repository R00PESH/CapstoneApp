package training.iqgateway.service.impl;

import java.util.Arrays;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;

import training.iqgateway.dto.ProviderDTO;

@Service
public class ProviderClientService {
      
	@Value("${provider.service.url}")
    private String providerServiceUrl;

    @Autowired
    private RestTemplate restTemplate;

    // Fetch all providers or apply optional filters via query params
    public List<ProviderDTO> fetchProvidersWithFilters(
        String name,
        String speciality,
        Double experience,
        String gender,
        Double rating,
        String location,
        Long zipcode,
        Double lat,
        Double lon,
        Double distanceKm,
        String insurancePlan
    ) {
        UriComponentsBuilder builder = UriComponentsBuilder
            .fromHttpUrl(providerServiceUrl + "/filter");
        if (name != null) builder.queryParam("name", name);
        if (speciality != null) builder.queryParam("speciality", speciality);
        if (experience != null) builder.queryParam("minExperience", experience);
        if (gender != null) builder.queryParam("gender", gender);
        if (rating != null) builder.queryParam("minRating", rating);
        if (location != null) builder.queryParam("location", location);
        if (zipcode != null) builder.queryParam("zipcode", zipcode);
        if (lat != null) builder.queryParam("lat", lat);
        if (lon != null) builder.queryParam("lon", lon);
        if (distanceKm != null) builder.queryParam("distanceKm", distanceKm);
        if (insurancePlan != null) builder.queryParam("insurancePlans", insurancePlan);

        ProviderDTO[] arr = restTemplate.getForObject(
            builder.toUriString(), ProviderDTO[].class);
        return Arrays.asList(arr);
    }

    // Fetch one provider by ID
    public ProviderDTO getProviderById(String providerId) {
        String url = providerServiceUrl + "/" + providerId;
        return restTemplate.getForObject(url, ProviderDTO.class);
    }
}
